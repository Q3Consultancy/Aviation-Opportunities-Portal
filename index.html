<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q3 Consultancy - Aviation Trading Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 12px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e5ba8 0%, #2d74c4 100%);
            color: white;
            padding: 25px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-container {
            width: 100px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .header-text {
            flex: 1;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 13px;
        }

        .role-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .role-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .role-badge.admin {
            background: #10b981;
        }

        .btn {
            padding: 6px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-primary {
            background: white;
            color: #1e5ba8;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .tab:hover {
            background: #e2e8f0;
        }

        .tab.active {
            color: #1e5ba8;
            border-bottom-color: #1e5ba8;
            background: white;
        }

        .content {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e5ba8 0%, #2d74c4 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 12px;
        }

        .search-box:focus {
            outline: none;
            border-color: #1e5ba8;
        }

        .btn-export {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-export:hover {
            background: #059669;
        }

        .btn-add {
            background: #1e5ba8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: none;
            font-size: 12px;
        }

        .btn-add.admin-only {
            display: inline-block;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 11px;
        }

        th {
            background: #f8fafc;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            font-size: 11px;
        }

        td {
            padding: 6px 6px;
            border-bottom: 1px solid #f1f5f9;
            white-space: nowrap;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Status color coding */
        .status-sold {
            background-color: #fee2e2 !important;
            color: #991b1b;
            font-weight: 600;
        }

        .status-buyer-looking {
            background-color: #d1fae5 !important;
            color: #065f46;
            font-weight: 600;
        }

        .status-buyer-submitted {
            background-color: #e9d5ff !important;
            color: #6b21a8;
            font-weight: 600;
        }

        .status-seller-looking {
            background-color: #dbeafe !important;
            color: #1e40af;
            font-weight: 600;
        }

        .editable {
            cursor: pointer;
            position: relative;
        }

        .editable:hover {
            background: #fef3c7;
        }

        td.read-only {
            cursor: default;
        }

        td.read-only:hover {
            background: inherit;
        }

        .edit-input {
            width: 100%;
            padding: 4px;
            border: 2px solid #1e5ba8;
            border-radius: 3px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #334155;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e5ba8;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #475569;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: none;
        }

        .delete-btn.admin-only {
            display: inline-block;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        footer {
            background: #1e293b;
            color: white;
            padding: 25px;
            text-align: center;
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .footer-company {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .footer-contact {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
        }

        .footer-contact a {
            color: #60a5fa;
            text-decoration: none;
        }

        .footer-contact a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            .role-toggle {
                position: static;
                margin-top: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="Q3 Consultancy Logo Sized.png" alt="Q3 Consultancy" onerror="this.parentElement.innerHTML='<div style=\'color:white;font-size:28px;font-weight:bold;\'>Q3</div>'">
            </div>
            <div class="header-text">
                <h1>Aviation Trading Portal</h1>
                <p class="subtitle">Aircraft & Engine Opportunities - Powered by Q3 Consultancy</p>
            </div>
            <div class="role-toggle">
                <span class="role-badge" id="roleBadge">External Viewer</span>
                <button class="btn btn-primary" id="loginBtn" onclick="showLoginModal()">Admin Login</button>
                <button class="btn btn-success" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('engines')">
                <span style="font-size: 18px;">‚öôÔ∏è</span> Engines
            </div>
            <div class="tab" onclick="switchTab('aircraft-sale')">
                <span style="font-size: 18px;">‚úàÔ∏è</span> Aircraft Sale
            </div>
            <div class="tab" onclick="switchTab('aircraft-lease')">
                <span style="font-size: 18px;">üõ©Ô∏è</span> Aircraft Lease
            </div>
        </div>

        <div class="content">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="controls">
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Search deals..." onkeyup="filterTable()">
                <button class="btn-export" onclick="exportToCSV()">üì• Export to CSV</button>
                <button class="btn-add" id="addBtn" onclick="showAddDealModal()">‚ûï Add Deal</button>
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <!-- Table will be populated by JavaScript -->
                </table>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-company">Q3 Consultancy</div>
                <div class="footer-contact">
                    <a href="/cdn-cgi/l/email-protection#a6d7d3cfc8c5dfe6d78b95c588c5c9cb">üìß <span class="__cf_email__" data-cfemail="b1c0c4d8dfd2c8f1c09c82d29fd2dedc">[email&#160;protected]</span></a>
                    <a href="tel:+971589362400">üì± +971 (0) 589 362 400 (UAE)</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-title">Admin Login</div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="passwordInput" placeholder="Enter admin password">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="hideLoginModal()">Cancel</button>
                <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Configuration
        const ADMIN_PASSWORD = 'admin123';
        let isAdmin = false;
        let currentTab = 'engines';
        let rawData = {};
        let data = {};

        // Hidden columns for external viewers
        const HIDDEN_COLUMNS = {
            'Engines': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)", 
                "Seller / Broker",
                "Unnamed: 17", 
                "Unnamed: 18", 
                "Unnamed: 19", 
                "Unnamed: 20"
            ],
            'Aircraft Sale': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)", 
                "Seller / Broker",
                "Unnamed: 15", 
                "Unnamed: 16", 
                "Unnamed: 17"
            ],
            'Aircraft Lease': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)", 
                "Seller / Broker",
                "Unnamed: 15", 
                "Unnamed: 16", 
                "Unnamed: 17"
            ]
        };

        // Hide closed deals for external viewers
        const HIDE_CLOSED_DEALS = false;

        // Status color mapping
        function getStatusClass(statusValue) {
            if (!statusValue) return '';
            const status = statusValue.toString().toLowerCase();
            if (status.includes('sold to another buyer')) return 'status-sold';
            if (status.includes('buyer: looking for a seller')) return 'status-buyer-looking';
            if (status.includes('buyer: submitted')) return 'status-buyer-submitted';
            if (status.includes('seller: looking for buyer')) return 'status-seller-looking';
            return '';
        }

        // Check if row should be hidden (for non-admin)
        function shouldHideRow(row) {
            if (isAdmin) return false;
            const status = row['Status'] || '';
            // Hide "[Sold to another Buyer]" rows for non-admin
            return status.toString().toLowerCase().includes('sold to another buyer');
        }

        // Convert columns/data format to array of objects
        function convertData(rawData) {
            const converted = {};
            for (const [sheetName, sheetData] of Object.entries(rawData)) {
                if (sheetData.columns && sheetData.data) {
                    converted[sheetName] = sheetData.data.map(row => {
                        const obj = {};
                        sheetData.columns.forEach((col, idx) => {
                            obj[col] = row[idx];
                        });
                        return obj;
                    });
                }
            }
            return converted;
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                rawData = await response.json();
                data = convertData(rawData);
                console.log('‚úÖ Data loaded successfully');
                renderTable();
                updateStats();
            } catch (error) {
                console.error('Error loading data:', error);
                const container = document.querySelector('.content');
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ef4444;">
                        <h2>‚ùå Error Loading Data</h2>
                        <p style="margin-top: 10px;">Failed to load data.json</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #64748b;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Render table
        function renderTable() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            const table = document.getElementById('dataTable');
            
            if (sheetData.length === 0) {
                table.innerHTML = '<tr><td>No data available</td></tr>';
                return;
            }

            // Get columns
            const allColumns = Object.keys(sheetData[0]);
            const hiddenCols = isAdmin ? [] : (HIDDEN_COLUMNS[sheetName] || []);
            const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));

            // Filter rows
            let filteredData = sheetData.filter(row => !shouldHideRow(row));

            // Build table header
            let html = '<thead><tr>';
            visibleColumns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            if (isAdmin) {
                html += '<th>Actions</th>';
            }
            html += '</tr></thead><tbody>';

            // Build table rows
            filteredData.forEach((row, index) => {
                html += '<tr>';
                visibleColumns.forEach(col => {
                    const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
                    const editableClass = isAdmin ? 'editable' : 'read-only';
                    const onclick = isAdmin ? `onclick="editCell(${index}, '${col.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')"` : '';
                    
                    // Apply status color if this is the Status column
                    let statusClass = '';
                    if (col === 'Status') {
                        statusClass = getStatusClass(value);
                    }
                    
                    html += `<td class="${editableClass} ${statusClass}" ${onclick} data-row="${index}" data-col="${col}">${value}</td>`;
                });
                if (isAdmin) {
                    html += `<td><button class="delete-btn admin-only" onclick="deleteDeal(${index})">üóëÔ∏è Delete</button></td>`;
                }
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        // Edit cell (admin only)
        function editCell(rowIndex, colName) {
            if (!isAdmin) return;

            const sheetName = getSheetName(currentTab);
            const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col="${colName}"]`);
            const currentValue = data[sheetName][rowIndex][colName];

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = currentValue;
            input.onblur = function() {
                saveCell(rowIndex, colName, input.value);
            };
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveCell(rowIndex, colName, input.value);
                }
            };

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        }

        // Save cell value
        function saveCell(rowIndex, colName, newValue) {
            const sheetName = getSheetName(currentTab);
            data[sheetName][rowIndex][colName] = newValue;
            renderTable();
            console.log('Cell updated:', {sheet: sheetName, row: rowIndex, column: colName, value: newValue});
        }

        // Delete deal (admin only)
        function deleteDeal(rowIndex) {
            if (!isAdmin) return;
            if (!confirm('Are you sure you want to delete this deal?')) return;

            const sheetName = getSheetName(currentTab);
            data[sheetName].splice(rowIndex, 1);
            renderTable();
            updateStats();
            console.log('Deal deleted:', {sheet: sheetName, row: rowIndex});
        }

        // Show add deal modal
        function showAddDealModal() {
            if (!isAdmin) return;
            alert('Add Deal feature: In a full implementation, this would open a form to add a new deal to the current tab.');
        }

        // Get sheet name from tab
        function getSheetName(tab) {
            const mapping = {
                'engines': 'Engines',
                'aircraft-sale': 'Aircraft Sale',
                'aircraft-lease': 'Aircraft Lease'
            };
            return mapping[tab];
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            renderTable();
            updateStats();
        }

        // Update statistics
        function updateStats() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            
            // Count visible records
            let totalRecords = sheetData.filter(row => !shouldHideRow(row)).length;

            const statsGrid = document.getElementById('statsGrid');
            
            // For non-admin: only show total records
            if (!isAdmin) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalRecords}</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                `;
            } else {
                // For admin: show all stats
                const allColumns = sheetData.length > 0 ? Object.keys(sheetData[0]) : [];
                const hiddenCols = HIDDEN_COLUMNS[sheetName] || [];
                const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalRecords}</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${allColumns.length}</div>
                        <div class="stat-label">Columns Visible</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">Full</div>
                        <div class="stat-label">Access Level</div>
                    </div>
                `;
            }
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const rows = document.querySelectorAll('#dataTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Export to CSV
        function exportToCSV() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            
            if (sheetData.length === 0) {
                alert('No data to export');
                return;
            }

            const allColumns = Object.keys(sheetData[0]);
            const hiddenCols = isAdmin ? [] : (HIDDEN_COLUMNS[sheetName] || []);
            const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));

            let filteredData = sheetData.filter(row => !shouldHideRow(row));

            // Build CSV
            let csv = visibleColumns.join(',') + '\n';
            filteredData.forEach(row => {
                const values = visibleColumns.map(col => {
                    const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sheetName}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Login functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('roleBadge').textContent = 'Admin';
                document.getElementById('roleBadge').classList.add('admin');
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('addBtn').classList.add('admin-only');
                hideLoginModal();
                renderTable();
                updateStats();
            } else {
                alert('Incorrect password');
            }
        }

        function logout() {
            isAdmin = false;
            document.getElementById('roleBadge').textContent = 'External Viewer';
            document.getElementById('roleBadge').classList.remove('admin');
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('addBtn').classList.remove('admin-only');
            renderTable();
            updateStats();
        }

        // Initialize
        window.onload = function() {
            loadData();
        };

        // Allow Enter key for password
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });
    </script>
</body>
</html>