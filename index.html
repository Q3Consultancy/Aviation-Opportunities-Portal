<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q3 Consultancy - Aviation Trading Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 12px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e5ba8 0%, #2d74c4 100%);
            color: white;
            padding: 25px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
            overflow: hidden;
        }

        /* Abstract curved lines watermark */
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -10%;
            right: -10%;
            bottom: -50%;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,0.03) 35px, rgba(255,255,255,0.03) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255,255,255,0.03) 35px, rgba(255,255,255,0.03) 70px);
            opacity: 0.5;
            pointer-events: none;
        }

        header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 50%, rgba(255,255,255,0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 50%, rgba(255,255,255,0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .logo-container {
            width: 140px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            z-index: 1;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.15) 0%, transparent 70%);
            border-radius: 10px;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .header-text {
            flex: 1;
            z-index: 1;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            opacity: 0.9;
            font-size: 13px;
        }

        .role-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1;
        }

        .role-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .role-badge.admin {
            background: #10b981;
        }

        .btn {
            padding: 6px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-primary {
            background: white;
            color: #1e5ba8;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .tab:hover {
            background: #e2e8f0;
        }

        .tab.active {
            color: #1e5ba8;
            border-bottom-color: #1e5ba8;
            background: white;
        }

        .content {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e5ba8 0%, #2d74c4 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 12px;
        }

        .search-box:focus {
            outline: none;
            border-color: #1e5ba8;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 6px 10px;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            font-size: 11px;
            min-width: 100px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #1e5ba8;
        }

        .btn-clear-filters {
            background: #64748b;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-export {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-export:hover {
            background: #059669;
        }

        .btn-add {
            background: #1e5ba8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: none;
            font-size: 12px;
        }

        .btn-add.admin-only {
            display: inline-block;
        }

        .btn-save {
            background: #f59e0b;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: none;
            font-size: 12px;
        }

        .btn-save.admin-only {
            display: inline-block;
        }

        .btn-save:hover {
            background: #d97706;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #10b981;
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
            z-index: 9999;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 11px;
        }

        th {
            background: #f8fafc;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: #e2e8f0;
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 10px;
        }

        th.sort-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }

        td {
            padding: 6px 6px;
            border-bottom: 1px solid #f1f5f9;
            white-space: nowrap;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Status color coding */
        .status-sold {
            background-color: #fee2e2 !important;
            color: #991b1b;
            font-weight: 600;
        }

        .status-buyer-looking {
            background-color: #d1fae5 !important;
            color: #065f46;
            font-weight: 600;
        }

        .status-buyer-submitted {
            background-color: #e9d5ff !important;
            color: #6b21a8;
            font-weight: 600;
        }

        .status-seller-looking, .status-lessor-looking {
            background-color: #dbeafe !important;
            color: #1e40af;
            font-weight: 600;
        }

        .status-lessee-looking {
            background-color: #d1fae5 !important;
            color: #065f46;
            font-weight: 600;
        }

        .status-buyer-reviewing {
            background-color: #fef3c7 !important;
            color: #92400e;
            font-weight: 600;
        }

        .status-buyer-finalizing {
            background-color: #fef3c7 !important;
            color: #92400e;
            font-weight: 600;
        }

        .editable {
            cursor: pointer;
            position: relative;
        }

        .editable:hover {
            background: #fef3c7;
        }

        td.read-only {
            cursor: default;
        }

        td.read-only:hover {
            background: inherit;
        }

        .edit-input {
            width: 100%;
            padding: 4px;
            border: 2px solid #1e5ba8;
            border-radius: 3px;
            font-size: 11px;
        }

        .file-upload-cell {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .file-icon {
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
        }

        .file-icon:hover {
            transform: scale(1.2);
        }

        .file-upload-input {
            display: none;
        }

        .file-link {
            color: #1e5ba8;
            text-decoration: none;
            font-size: 16px;
            margin-right: 4px;
        }

        .file-link:hover {
            transform: scale(1.2);
            display: inline-block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content.wide {
            max-width: 760px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 20px;
        }

        .form-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-section-title {
            grid-column: 1 / -1;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #1e5ba8;
            border-bottom: 2px solid #dbeafe;
            padding-bottom: 4px;
            margin-top: 6px;
        }

        .form-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 13px;
            background: white;
        }

        .form-select:focus {
            outline: none;
            border-color: #1e5ba8;
        }

        .required-star {
            color: #ef4444;
            margin-left: 2px;
        }

        .modal-title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #94a3b8;
            padding: 0 4px;
            line-height: 1;
        }

        .modal-close-btn:hover {
            color: #334155;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #334155;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e5ba8;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #475569;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: none;
        }

        .delete-btn.admin-only {
            display: inline-block;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        footer {
            background: #1e293b;
            color: white;
            padding: 25px;
            text-align: center;
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .footer-company {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .footer-contact {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
        }

        .footer-contact a {
            color: #60a5fa;
            text-decoration: none;
        }

        .footer-contact a:hover {
            text-decoration: underline;
        }

        .country-flag {
            display: inline-block;
            margin-left: 4px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            .role-toggle {
                position: static;
                margin-top: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="Q3 Consultancy Logo Sized.png" alt="Q3 Consultancy" onerror="this.parentElement.innerHTML='<div style=\'color:white;font-size:32px;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.2);\'>Q3</div>'">
            </div>
            <div class="header-text">
                <h1>Aviation Trading Portal</h1>
                <p class="subtitle">Aircraft, Engine and Parts Opportunities - Powered by Q3 Consultancy</p>
            </div>
            <div class="role-toggle">
                <span class="role-badge" id="roleBadge" style="display:none;">External Viewer</span>
                <button class="btn btn-primary" id="loginBtn" onclick="showLoginModal()">Admin Login</button>
                <button class="btn btn-success" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('engines')">
                <span style="font-size: 18px;">‚öôÔ∏è</span> Engines
            </div>
            <div class="tab" onclick="switchTab('aircraft-sale')">
                <span style="font-size: 18px;">‚úàÔ∏è</span> Aircraft Sale
            </div>
            <div class="tab" onclick="switchTab('aircraft-lease')">
                <span style="font-size: 18px;">üõ©Ô∏è</span> Aircraft Lease
            </div>
            <div class="tab" onclick="switchTab('parts')">
                <span style="font-size: 18px;">üîß</span> Parts
            </div>
        </div>

        <div class="content">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="controls">
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Search deals..." onkeyup="filterTable()">
                <button class="btn-export" onclick="exportToCSV()">üì• Export to CSV</button>
                <button class="btn-save" id="saveBtn" onclick="saveChanges()">üíæ Save</button>
                <button class="btn-add" id="addBtn" onclick="showAddDealModal()">‚ûï Add Deal</button>
            </div>

            <div class="filter-row" id="filterRow">
                <!-- Column filters will be populated by JavaScript -->
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <!-- Table will be populated by JavaScript -->
                </table>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-company">Q3 Consultancy</div>
                <div class="footer-contact">
                    <a href="/cdn-cgi/l/email-protection#abdadec2c5c8d2ebda8698c885c8c4c6">üìß Email</a>
                    <span>üì± +971 (0) 589 362 400 üá¶üá™</span>
                </div>
            </div>
        </footer>
    </div>


    <!-- Add Deal Modal -->
    <div class="modal" id="addDealModal">
        <div class="modal-content wide">
            <div class="modal-title-bar">
                <div class="modal-title" id="addDealModalTitle">‚ûï Add New Deal ‚Äî Engines</div>
                <button class="modal-close-btn" onclick="hideAddDealModal()" title="Close">‚úï</button>
            </div>
            <form id="addDealForm" onsubmit="submitAddDeal(event)">
                <div class="form-grid" id="addDealFormFields">
                    <!-- Fields injected by JS based on current tab -->
                </div>
                <div class="modal-actions" style="margin-top:20px;">
                    <button type="button" class="btn btn-cancel" onclick="hideAddDealModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">‚úÖ Save Deal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-title">Admin Login</div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="passwordInput" placeholder="Enter admin password">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="hideLoginModal()">Cancel</button>
                <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Configuration
        const ADMIN_PASSWORD = 'admin123';
        let isAdmin = false;
        let currentTab = 'engines';
        let rawData = {};
        let data = {};
        let sortColumn = null;
        let sortDirection = 'asc';
        let columnFilters = {};

        // Today's date in DD/MMM/YYYY format
        const today = new Date();
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const todayFormatted = `${String(today.getDate()).padStart(2, '0')}/${months[today.getMonth()]}/${today.getFullYear()}`;

        // Country flag mapping
        const countryFlags = {
            'USA': 'üá∫üá∏', 'UK': 'üá¨üáß', 'UAE': 'üá¶üá™', 'Germany': 'üá©üá™', 'France': 'üá´üá∑',
            'Canada': 'üá®üá¶', 'Australia': 'üá¶üá∫', 'Singapore': 'üá∏üá¨', 'Japan': 'üáØüáµ',
            'China': 'üá®üá≥', 'India': 'üáÆüá≥', 'Brazil': 'üáßüá∑', 'Mexico': 'üá≤üáΩ',
            'Spain': 'üá™üá∏', 'Italy': 'üáÆüáπ', 'Netherlands': 'üá≥üá±', 'Switzerland': 'üá®üá≠',
            'Sweden': 'üá∏üá™', 'Norway': 'üá≥üá¥', 'Denmark': 'üá©üá∞', 'Ireland': 'üáÆüá™',
            'Turkey': 'üáπüá∑', 'South Korea': 'üá∞üá∑', 'Russia': 'üá∑üá∫', 'Saudi Arabia': 'üá∏üá¶',
            'Qatar': 'üá∂üá¶', 'Kuwait': 'üá∞üáº', 'Bahrain': 'üáßüá≠', 'Oman': 'üá¥üá≤',
            'Israel': 'üáÆüá±', 'South Africa': 'üáøüá¶', 'New Zealand': 'üá≥üáø',
            'Thailand': 'üáπüá≠', 'Malaysia': 'üá≤üáæ', 'Indonesia': 'üáÆüá©',
            'Philippines': 'üáµüá≠', 'Vietnam': 'üáªüá≥', 'Egypt': 'üá™üá¨',
            'Nigeria': 'üá≥üá¨', 'Kenya': 'üá∞üá™', 'Argentina': 'üá¶üá∑',
            'Chile': 'üá®üá±', 'Colombia': 'üá®üá¥', 'Peru': 'üáµüá™'
        };


        // Format numbers with commas (no decimals)
        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return value;
            
            // Check if it's a number or can be converted to one
            const numValue = typeof value === 'number' ? value : parseFloat(String(value).replace(/,/g, ''));
            
            if (isNaN(numValue)) return value;
            
            // Format with commas, no decimals
            return Math.round(numValue).toLocaleString('en-US');
        }


        // Columns that should display numbers with comma formatting
        const NUMBER_COLUMNS = [
            'Cycles Remaining',
            "Seller's Price \n(USD)",
            'Team Commission\n(USD)',
            'Price \n(USD)',
            'Total Time (Hours)',
            'Total Cycles',
            'Lease Rate \n(USD/Month)'
        ];

        // Add flag to location text
        function addFlagToLocation(location) {
            if (!location) return '';
            const match = location.match(/\[([^\]]+)\]/);
            if (match) {
                const country = match[1];
                const flag = countryFlags[country] || '';
                if (flag) {
                    return location.replace(/\]/, `${flag}]`);
                }
            }
            return location;
        }

        // Hidden columns for external viewers
        const HIDDEN_COLUMNS = {
            'Engines': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)", 
                "Buyer(s) 2",
                "Buyer(s) 3",
                "Buyer(s) 4",
                "Buyer(s) 5",
                "Seller / Broker",
                "LLP Sheet",
                "Last Shop Visit",
                "Last Shop Visit Report",
                "QEC / Accessory List",
                "Engine History",
                "NIS"
            ],
            'Aircraft Sale': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)", 
                "Buyer(s) 2",
                "Buyer(s) 3",
                "Buyer(s) 4",
                "Seller / Broker",
                "Manufacturers S/N",
                "Total Time"
            ],
            'Aircraft Lease': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)", 
                "Buyer(s) 2",
                "Buyer(s) 3",
                "Buyer(s) 4",
                "Seller / Broker"
            ],
            'Parts': [
                "Seller's Price \n(USD)", 
                "Team Commission\n(USD)", 
                "Buyer(s)",
                "Seller / Broker",
                "Manufacturers S/N",
                "Total Time"
            ]
        };

        // Columns to show filter boxes for (non-admin). null = show all.
        const FILTER_COLUMNS = {
            'Engines': ['Deal #', 'Engine', 'ESN', 'Location', 'Status', 'Date Received'],
            'Aircraft Sale': null,
            'Aircraft Lease': null,
            'Parts': null
        };

        // Status color mapping
        function getStatusClass(statusValue) {
            if (!statusValue) return '';
            const status = statusValue.toString().toLowerCase();
            if (status.includes('sold to another buyer')) return 'status-sold';
            if (status.includes('buyer request')) return 'status-buyer-looking';
            if (status.includes('buyer: submitted')) return 'status-buyer-submitted';
            if (status.includes('seller request')) return 'status-seller-looking';
            if (status.includes('lessor request')) return 'status-lessor-looking';
            if (status.includes('lessee request')) return 'status-lessee-looking';
            if (status.includes('buyer: reviewing data')) return 'status-buyer-reviewing';
            if (status.includes('buyer: finalizing loi and apa')) return 'status-buyer-finalizing';
            return '';
        }

        // Cutoff date: hide entries before 1 Nov 2025 for non-admin
        const CUTOFF_DATE = new Date('2025-11-01');

        // Parse a date string in various formats to a Date object
        function parseDateReceived(dateStr) {
            if (!dateStr) return null;
            const s = dateStr.toString().trim();
            // DD/Mon/YYYY e.g. 15/Jan/2026
            const m1 = s.match(/^(\d{1,2})\/([A-Za-z]{3})\/(\d{4})$/);
            if (m1) {
                const monthMap = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                const mo = monthMap[m1[2]];
                if (mo !== undefined) return new Date(parseInt(m1[3]), mo, parseInt(m1[1]));
            }
            // Try native parse
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }

        // Check if row should be hidden (for non-admin)
        function shouldHideRow(row) {
            if (isAdmin) return false;
            const status = row['Status'] || '';
            if (status.toString().toLowerCase().includes('sold to another buyer')) return true;
            // Hide entries dated before 1 Nov 2025
            const dateReceived = parseDateReceived(row['Date Received']);
            if (dateReceived && dateReceived < CUTOFF_DATE) return true;
            return false;
        }

        // Convert columns/data format to array of objects
        function convertData(rawData) {
            const converted = {};
            for (const [sheetName, sheetData] of Object.entries(rawData)) {
                if (sheetData.columns && sheetData.data) {
                    converted[sheetName] = sheetData.data.map(row => {
                        const obj = {};
                        sheetData.columns.forEach((col, idx) => {
                            obj[col] = row[idx];
                        });
                        return obj;
                    });
                }
            }
            return converted;
        }

        // Sort table
        function sortTable(column) {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            sheetData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                }

                const strA = valA.toString().toLowerCase();
                const strB = valB.toString().toLowerCase();
                if (sortDirection === 'asc') {
                    return strA.localeCompare(strB);
                } else {
                    return strB.localeCompare(strA);
                }
            });

            renderTable();
        }

        // Render column filters
        function renderFilters() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            if (sheetData.length === 0) return;

            const allColumns = Object.keys(sheetData[0]);
            const hiddenCols = isAdmin ? [] : (HIDDEN_COLUMNS[sheetName] || []);
            let visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));
            // In non-admin mode, restrict filter boxes to FILTER_COLUMNS list if defined
            if (!isAdmin && FILTER_COLUMNS[sheetName]) {
                visibleColumns = visibleColumns.filter(col => FILTER_COLUMNS[sheetName].includes(col));
            }

            const filterRow = document.getElementById('filterRow');
            let html = '';
            
            visibleColumns.forEach(col => {
                const filterId = `filter-${col.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const filterValue = columnFilters[col] || '';
                html += `<input type="text" 
                    class="filter-input" 
                    id="${filterId}" 
                    placeholder="Filter ${col}..." 
                    value="${filterValue}"
                    onkeyup="updateColumnFilter('${col.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', this.value)">`;
            });
            
            html += '<button class="btn-clear-filters" onclick="clearAllFilters()">Clear Filters</button>';
            filterRow.innerHTML = html;
        }

        // Update column filter
        function updateColumnFilter(column, value) {
            columnFilters[column] = value.toLowerCase();
            filterTable();
        }

        // Clear all filters
        function clearAllFilters() {
            columnFilters = {};
            renderFilters();
            filterTable();
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                rawData = await response.json();
                data = convertData(rawData);
                console.log('‚úÖ Data loaded successfully');
                renderTable();
                renderFilters();
                updateStats();
            } catch (error) {
                console.error('Error loading data:', error);
                const container = document.querySelector('.content');
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ef4444;">
                        <h2>‚ùå Error Loading Data</h2>
                        <p style="margin-top: 10px;">Failed to load data.json</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #64748b;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Render table
        function renderTable() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            const table = document.getElementById('dataTable');
            
            if (sheetData.length === 0) {
                table.innerHTML = '<tr><td>No data available</td></tr>';
                return;
            }

            const allColumns = Object.keys(sheetData[0]);
            const hiddenCols = isAdmin ? [] : (HIDDEN_COLUMNS[sheetName] || []);
            const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));

            let filteredData = sheetData.filter(row => !shouldHideRow(row));

            // Build table header with sort functionality
            let html = '<thead><tr>';
            visibleColumns.forEach(col => {
                const sortClass = sortColumn === col ? (sortDirection === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                html += `<th class="sortable ${sortClass}" onclick="sortTable('${col.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')">${col}</th>`;
            });
            if (isAdmin) {
                html += '<th>Actions</th>';
            }
            html += '</tr></thead><tbody>';

            // Build table rows
            filteredData.forEach((row, index) => {
                html += '<tr>';
                visibleColumns.forEach(col => {
                    let value = row[col] !== null && row[col] !== undefined ? row[col] : '';
                    
                    // Apply number formatting if column is in NUMBER_COLUMNS
                    if (NUMBER_COLUMNS.includes(col) && value !== '') {
                        value = formatNumber(value);
                    }
                    
                    if (col === 'Location') {
                        value = addFlagToLocation(value);
                    }
                    
                    // Handle Files column
                    if (col === 'Files') {
                        if (isAdmin) {
                            const fileEntries = parseFileEntries(value);
                            const sheetLabel = getSheetName(currentTab);
                            const fileLinksHtml = fileEntries.map((entry, fi) => {
                                const ext = entry.originalName.split('.').pop() || 'file';
                                const rowData = filteredData[index];
                                const dealNum = rowData ? (rowData['Deal #'] || rowData['No'] || (index+1)) : (index+1);
                                const dlName = `Q3 Consultancy - ${dealNum} - ${sheetLabel}.${ext}`;
                                return `<a href="${entry.url}" class="file-link" target="_blank" download="${dlName}" title="View/Download: ${entry.originalName}">üìÑ</a>`;
                            }).join('');
                            // Grey paperclip icon when no files, coloured when files exist
                            const uploadIconStyle = fileEntries.length === 0 ? 'filter: grayscale(100%) opacity(0.4);' : '';
                            html += `<td class="file-upload-cell">
                                <span class="file-icon" onclick="uploadFile(${index})" title="Upload file" style="${uploadIconStyle}">üìé</span>
                                <input type="file" id="file-${index}" class="file-upload-input" onchange="handleFileUpload(${index}, this)" accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx,.csv">
                                ${fileLinksHtml}
                            </td>`;
                        } else {
                            const fileEntries = parseFileEntries(value);
                            const sheetLabel = getSheetName(currentTab);
                            if (fileEntries.length === 0) {
                                // Show grey file icon when no file present
                                html += `<td><span style="font-size:16px;filter:grayscale(100%) opacity(0.35);" title="No file uploaded">üìÑ</span></td>`;
                            } else {
                                const fileLinksHtml = fileEntries.map((entry, fi) => {
                                    const ext = entry.originalName.split('.').pop() || 'file';
                                    const rowData = filteredData[index];
                                    const dealNum = rowData ? (rowData['Deal #'] || rowData['No'] || (index+1)) : (index+1);
                                    const dlName = `Q3 Consultancy - ${dealNum} - ${sheetLabel}.${ext}`;
                                    return `<a href="${entry.url}" class="file-link" target="_blank" download="${dlName}" title="View/Download: ${entry.originalName}">üìÑ</a>`;
                                }).join('');
                                html += `<td>${fileLinksHtml}</td>`;
                            }
                        }
                        return;
                    }

                    // All columns editable in admin except Files
                    const editableClass = isAdmin && col !== 'Files' ? 'editable' : 'read-only';
                    const colIdx = visibleColumns.indexOf(col);
                    const onclick = isAdmin && col !== 'Files' ? `onclick="editCell(${index}, ${colIdx})"` : '';
                    
                    let statusClass = '';
                    if (col === 'Status') {
                        statusClass = getStatusClass(value);
                    }
                    
                    html += `<td class="${editableClass} ${statusClass}" ${onclick} data-row="${index}" data-col-idx="${colIdx}">${value}</td>`;
                });
                if (isAdmin) {
                    html += `<td><button class="delete-btn admin-only" onclick="deleteDeal(${index})">üóëÔ∏è Delete</button></td>`;
                }
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        // File upload functions
        function uploadFile(rowIndex) {
            document.getElementById(`file-${rowIndex}`).click();
        }

        function handleFileUpload(rowIndex, input) {
            if (!isAdmin) return;
            
            const file = input.files[0];
            if (!file) return;

            const fileURL = URL.createObjectURL(file);
            const sheetName = getSheetName(currentTab);
            
            // Get deal number for naming
            const rowData = data[sheetName][rowIndex];
            const dealNum = rowData['Deal #'] || rowData['No'] || rowIndex + 1;
            
            // Store as JSON entry: url|originalName
            const fileEntry = `${fileURL}|${file.name}|${dealNum}`;
            
            const currentFiles = data[sheetName][rowIndex]['Files'] || '';
            const fileList = currentFiles ? currentFiles.split(';;').map(f => f.trim()).filter(f => f) : [];
            fileList.push(fileEntry);
            
            data[sheetName][rowIndex]['Files'] = fileList.join(';;');
            renderTable();
            
            alert(`File "${file.name}" uploaded successfully!\nNote: In production, this would be stored on a server.`);
        }
        
        // Parse file entries (stored as url|name|dealNum separated by ;;)
        function parseFileEntries(filesValue) {
            if (!filesValue) return [];
            // Handle both old comma-separated URLs and new ;; separated entries
            if (filesValue.includes(';;') || filesValue.includes('|')) {
                return filesValue.split(';;').map(f => f.trim()).filter(f => f).map(entry => {
                    const parts = entry.split('|');
                    return { url: parts[0] || entry, originalName: parts[1] || 'file', dealNum: parts[2] || '' };
                });
            } else {
                // Legacy: comma-separated URLs
                return filesValue.split(',').map(f => f.trim()).filter(f => f).map(f => ({
                    url: f, originalName: 'file', dealNum: ''
                }));
            }
        }

        // Edit cell (admin only)
        function editCell(rowIndex, colIdx) {
            if (!isAdmin) return;

            const sheetName = getSheetName(currentTab);
            const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col-idx="${colIdx}"]`);
            if (!cell) return;
            
            const sheetData = data[sheetName] || [];
            const allColumns = Object.keys(sheetData[0] || {});
            const hiddenCols = isAdmin ? [] : (HIDDEN_COLUMNS[sheetName] || []);
            const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));
            const colName = visibleColumns[colIdx];
            if (!colName) return;
            
            const currentValue = data[sheetName][rowIndex][colName];

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            // Show raw value (without comma formatting) for editing
            input.value = currentValue !== null && currentValue !== undefined ? currentValue : '';
            input.onblur = function() {
                saveCell(rowIndex, colName, input.value);
            };
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveCell(rowIndex, colName, input.value);
                }
            };

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        }

        // Save cell value
        function saveCell(rowIndex, colName, newValue) {
            const sheetName = getSheetName(currentTab);
            data[sheetName][rowIndex][colName] = newValue;
            renderTable();
            console.log('Cell updated:', {sheet: sheetName, row: rowIndex, column: colName, value: newValue});
        }

        // Delete deal (admin only)
        function deleteDeal(rowIndex) {
            if (!isAdmin) return;
            if (!confirm('Are you sure you want to delete this deal?')) return;

            const sheetName = getSheetName(currentTab);
            data[sheetName].splice(rowIndex, 1);
            renderTable();
            updateStats();
            console.log('Deal deleted:', {sheet: sheetName, row: rowIndex});
        }

        // ================================================
        // ADD DEAL ‚Äî Full Implementation
        // ================================================

        // Field definitions per tab
        const TAB_FORM_FIELDS = {
            'Engines': [
                { section: 'üîß Engine Details' },
                { key: 'Deal #',          label: 'Deal #',             type: 'text',   required: true,  placeholder: 'e.g. 7B099' },
                { key: 'Engine',          label: 'Engine Type',        type: 'text',   required: true,  placeholder: 'e.g. CFM56-7B' },
                { key: 'ESN',             label: 'ESN',                type: 'text',   required: false, placeholder: 'Engine Serial Number' },
                { key: 'Cycles Remaining',label: 'Cycles Remaining',   type: 'number', required: false, placeholder: 'e.g. 10000' },
                { key: 'LLP Sheet',       label: 'LLP Sheet',          type: 'select', required: false, options: ['', 'Yes', 'No', 'Requested'] },
                { key: 'Last Shop Visit', label: 'Last Shop Visit',    type: 'text',   required: false, placeholder: 'e.g. 2023' },
                { key: 'Last Shop Visit Report', label: 'Last Shop Visit Report', type: 'select', required: false, options: ['', 'Yes', 'No', 'Requested'] },
                { key: 'QEC / Accessory List',   label: 'QEC / Accessory List',   type: 'select', required: false, options: ['', 'Yes', 'No', 'Requested'] },
                { key: 'Engine History',  label: 'Engine History',     type: 'select', required: false, options: ['', 'Yes', 'No', 'Requested'] },
                { key: 'NIS',             label: 'NIS',                type: 'text',   required: false, placeholder: 'Not-in-service details' },
                { key: 'Location',        label: 'Location',           type: 'text',   required: false, placeholder: 'e.g. [USA]' },
                { section: 'üí∞ Pricing (Admin)' },
                { key: "Seller's Price \n(USD)", label: "Seller's Price (USD)",  type: 'number', required: false, placeholder: '0' },
                { key: 'Team Commission\n(USD)', label: 'Team Commission (USD)', type: 'number', required: false, placeholder: '0' },
                { key: 'Price \n(USD)',           label: 'Price (USD)',           type: 'number', required: false, placeholder: '0' },
                { section: 'üë• Parties' },
                { key: 'Seller / Broker', label: 'Seller / Broker',   type: 'text',   required: false, placeholder: 'Name / Company' },
                { key: 'Buyer(s)',        label: 'Buyer(s)',           type: 'text',   required: false, placeholder: 'Primary buyer' },
                { key: 'Buyer(s) 2',     label: 'Buyer(s) 2',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 3',     label: 'Buyer(s) 3',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 4',     label: 'Buyer(s) 4',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 5',     label: 'Buyer(s) 5',        type: 'text',   required: false, placeholder: '' },
                { section: 'üìã Status & Date' },
                { key: 'Status',          label: 'Status',             type: 'select', required: false, options: ['', 'Seller Request', 'Buyer Request', 'Buyer: Submitted', 'Buyer: Reviewing data', 'Buyer: Finalizing LOI and APA', 'Lessor Request', 'Lessee Request', 'Closed [Sold to another Buyer]'] },
                { key: 'Date Received',   label: 'Date Received',      type: 'text',   required: false, placeholder: 'DD/Mon/YYYY' },
            ],
            'Aircraft Sale': [
                { section: '‚úàÔ∏è Aircraft Details' },
                { key: 'Deal #',           label: 'Deal #',             type: 'text',   required: true,  placeholder: 'e.g. AC030' },
                { key: 'Aircraft',         label: 'Aircraft Type',      type: 'text',   required: true,  placeholder: 'e.g. A320-232' },
                { key: 'Engine',           label: 'Engine',             type: 'text',   required: false, placeholder: 'e.g. V2527-A5' },
                { key: 'Manufacturers S/N',label: 'Manufacturers S/N',  type: 'text',   required: false, placeholder: 'MSN' },
                { key: 'Date-Of-Manufacture',label: 'Date of Manufacture', type: 'text', required: false, placeholder: 'YYYY-MM-DD' },
                { key: 'Total Time',       label: 'Total Time (Hours)', type: 'number', required: false, placeholder: '0' },
                { key: 'Total Cycles',     label: 'Total Cycles',       type: 'number', required: false, placeholder: '0' },
                { key: 'Configuration',    label: 'Configuration',      type: 'text',   required: false, placeholder: 'e.g. 174 pax' },
                { key: 'Location',         label: 'Location',           type: 'text',   required: false, placeholder: 'e.g. [UAE]' },
                { section: 'üí∞ Pricing (Admin)' },
                { key: "Seller's Price \n(USD)", label: "Seller's Price (USD)",  type: 'number', required: false, placeholder: '0' },
                { key: 'Team Commission\n(USD)', label: 'Team Commission (USD)', type: 'number', required: false, placeholder: '0' },
                { key: 'Price \n(USD)',           label: 'Price (USD)',           type: 'number', required: false, placeholder: '0' },
                { section: 'üë• Parties' },
                { key: 'Seller / Broker',  label: 'Seller / Broker',   type: 'text',   required: false, placeholder: 'Name / Company' },
                { key: 'Buyer(s)',         label: 'Buyer(s)',           type: 'text',   required: false, placeholder: 'Primary buyer' },
                { key: 'Buyer(s) 2',      label: 'Buyer(s) 2',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 3',      label: 'Buyer(s) 3',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 4',      label: 'Buyer(s) 4',        type: 'text',   required: false, placeholder: '' },
                { section: 'üìã Status & Date' },
                { key: 'Status',           label: 'Status',             type: 'select', required: false, options: ['', 'Seller Request', 'Buyer Request', 'Buyer: Submitted', 'Buyer: Reviewing data', 'Buyer: Finalizing LOI and APA', 'Lessor Request', 'Lessee Request', 'Closed [Sold to another Buyer]'] },
                { key: 'Date Received',    label: 'Date Received',      type: 'text',   required: false, placeholder: 'DD/Mon/YYYY' },
            ],
            'Aircraft Lease': [
                { section: '‚úàÔ∏è Aircraft Details' },
                { key: 'Deal #',           label: 'Deal #',             type: 'text',   required: true,  placeholder: 'e.g. LAC007' },
                { key: 'Aircraft',         label: 'Aircraft Type',      type: 'text',   required: true,  placeholder: 'e.g. A320-232' },
                { key: 'Engine',           label: 'Engine',             type: 'text',   required: false, placeholder: 'e.g. V2527-A5' },
                { key: 'Manufacturers S/N',label: 'Manufacturers S/N',  type: 'text',   required: false, placeholder: 'MSN' },
                { key: 'Date-Of-Manufacture',label: 'Date of Manufacture', type: 'text', required: false, placeholder: 'YYYY-MM-DD' },
                { key: 'Total Time',       label: 'Total Time (Hours)', type: 'number', required: false, placeholder: '0' },
                { key: 'Total Cycles',     label: 'Total Cycles',       type: 'number', required: false, placeholder: '0' },
                { key: 'Configuration',    label: 'Configuration',      type: 'text',   required: false, placeholder: 'e.g. 174 pax' },
                { key: 'Location',         label: 'Location',           type: 'text',   required: false, placeholder: 'e.g. [UAE]' },
                { section: 'üí∞ Pricing (Admin)' },
                { key: "Seller's Price \n(USD)", label: "Lease Rate (USD/Month)", type: 'number', required: false, placeholder: '0' },
                { key: 'Team Commission\n(USD)', label: 'Team Commission (USD)',  type: 'number', required: false, placeholder: '0' },
                { key: 'Price \n(USD)',           label: 'Price (USD)',            type: 'number', required: false, placeholder: '0' },
                { section: 'üë• Parties' },
                { key: 'Seller / Broker',  label: 'Seller / Broker',   type: 'text',   required: false, placeholder: 'Name / Company' },
                { key: 'Buyer(s)',         label: 'Buyer(s)',           type: 'text',   required: false, placeholder: 'Primary lessee' },
                { key: 'Buyer(s) 2',      label: 'Buyer(s) 2',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 3',      label: 'Buyer(s) 3',        type: 'text',   required: false, placeholder: '' },
                { key: 'Buyer(s) 4',      label: 'Buyer(s) 4',        type: 'text',   required: false, placeholder: '' },
                { section: 'üìã Status & Date' },
                { key: 'Status',           label: 'Status',             type: 'select', required: false, options: ['', 'Lessor Request', 'Lessee Request', 'Seller Request', 'Buyer Request', 'Buyer: Submitted', 'Buyer: Reviewing data', 'Closed [Sold to another Buyer]'] },
                { key: 'Date Received',    label: 'Date Received',      type: 'text',   required: false, placeholder: 'DD/Mon/YYYY' },
            ],
            'Parts': [
                { section: 'üî© Part Details' },
                { key: 'Deal #',           label: 'Deal #',             type: 'text',   required: true,  placeholder: 'e.g. PT001' },
                { key: 'Part',             label: 'Part Description',   type: 'text',   required: true,  placeholder: 'e.g. Landing Gear Assembly' },
                { key: 'Manufacturers S/N',label: 'Manufacturers S/N',  type: 'text',   required: false, placeholder: 'Part serial number' },
                { key: 'Location',         label: 'Location',           type: 'text',   required: false, placeholder: 'e.g. [USA]' },
                { section: 'üí∞ Pricing (Admin)' },
                { key: "Seller's Price \n(USD)", label: "Seller's Price (USD)",  type: 'number', required: false, placeholder: '0' },
                { key: 'Team Commission\n(USD)', label: 'Team Commission (USD)', type: 'number', required: false, placeholder: '0' },
                { key: 'Price \n(USD)',           label: 'Price (USD)',           type: 'number', required: false, placeholder: '0' },
                { section: 'üë• Parties' },
                { key: 'Seller / Broker',  label: 'Seller / Broker',   type: 'text',   required: false, placeholder: 'Name / Company' },
                { key: 'Buyer(s)',         label: 'Buyer(s)',           type: 'text',   required: false, placeholder: 'Primary buyer' },
                { section: 'üìã Status & Date' },
                { key: 'Status',           label: 'Status',             type: 'select', required: false, options: ['', 'Seller Request', 'Buyer Request', 'Buyer: Submitted', 'Buyer: Reviewing data', 'Buyer: Finalizing LOI and APA', 'Closed [Sold to another Buyer]'] },
                { key: 'Date Received',    label: 'Date Received',      type: 'text',   required: false, placeholder: 'DD/Mon/YYYY' },
            ]
        };

        function showAddDealModal() {
            if (!isAdmin) return;

            const sheetName = getSheetName(currentTab);
            const fields = TAB_FORM_FIELDS[sheetName] || [];

            // Update modal title
            const tabEmoji = { 'Engines': 'üîß', 'Aircraft Sale': '‚úàÔ∏è', 'Aircraft Lease': 'üõ´', 'Parts': 'üî©' };
            document.getElementById('addDealModalTitle').textContent =
                `‚ûï Add New Deal ‚Äî ${tabEmoji[sheetName] || ''} ${sheetName}`;

            // Build form fields
            const container = document.getElementById('addDealFormFields');
            let html = '';

            fields.forEach(field => {
                if (field.section) {
                    html += `<div class="form-section-title">${field.section}</div>`;
                    return;
                }
                const reqStar = field.required ? '<span class="required-star">*</span>' : '';
                const fieldId = `add_${field.key.replace(/[^a-zA-Z0-9]/g, '_')}`;

                if (field.type === 'select') {
                    const opts = field.options.map(o => `<option value="${o}">${o || '‚Äî Select ‚Äî'}</option>`).join('');
                    html += `<div class="form-group">
                        <label class="form-label" for="${fieldId}">${field.label}${reqStar}</label>
                        <select class="form-select" id="${fieldId}" data-key="${field.key}" ${field.required ? 'required' : ''}>
                            ${opts}
                        </select>
                    </div>`;
                } else {
                    html += `<div class="form-group">
                        <label class="form-label" for="${fieldId}">${field.label}${reqStar}</label>
                        <input type="${field.type}" class="form-input" id="${fieldId}" data-key="${field.key}"
                               placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
                    </div>`;
                }
            });

            container.innerHTML = html;

            // Pre-fill Date Received with today
            const dateField = container.querySelector('[data-key="Date Received"]');
            if (dateField) dateField.value = todayFormatted;

            // Pre-fill No (next sequential)
            const sheetData = data[sheetName] || [];
            const nextNo = sheetData.length > 0
                ? Math.max(...sheetData.map(r => parseInt(r['No']) || 0)) + 1
                : 1;
            // No is auto-set on submit

            document.getElementById('addDealModal').classList.add('show');
            // Focus first required field
            const firstInput = container.querySelector('input[required], select[required]');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);
        }

        function hideAddDealModal() {
            document.getElementById('addDealModal').classList.remove('show');
            document.getElementById('addDealForm').reset();
        }

        function submitAddDeal(event) {
            event.preventDefault();
            if (!isAdmin) return;

            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];

            // Collect form values
            const newRow = {};
            const fields = document.getElementById('addDealFormFields').querySelectorAll('[data-key]');
            fields.forEach(el => {
                const key = el.getAttribute('data-key');
                newRow[key] = el.value.trim();
            });

            // Auto-assign No
            const nextNo = sheetData.length > 0
                ? Math.max(...sheetData.map(r => parseInt(r['No']) || 0)) + 1
                : 1;
            newRow['No'] = String(nextNo);
            newRow['Files'] = '';

            // Validate required fields
            const tabFields = TAB_FORM_FIELDS[sheetName] || [];
            for (const f of tabFields) {
                if (f.section) continue;
                if (f.required && !newRow[f.key]) {
                    alert(`‚ö†Ô∏è "${f.label}" is required.`);
                    document.getElementById(`add_${f.key.replace(/[^a-zA-Z0-9]/g, '_')}`).focus();
                    return;
                }
            }

            // Add to data
            data[sheetName].push(newRow);

            hideAddDealModal();
            renderTable();
            updateStats();
            renderFilters();

            // Scroll to bottom to show new row
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) tableContainer.scrollTop = tableContainer.scrollHeight;

            // Brief success flash
            const btn = document.getElementById('addBtn');
            const orig = btn.textContent;
            btn.textContent = '‚úÖ Deal Added!';
            btn.style.background = '#22c55e';
            setTimeout(() => {
                btn.textContent = orig;
                btn.style.background = '';
            }, 2000);
        }

        // Get sheet name from tab
        function getSheetName(tab) {
            const mapping = {
                'engines': 'Engines',
                'aircraft-sale': 'Aircraft Sale',
                'aircraft-lease': 'Aircraft Lease',
                'parts': 'Parts'
            };
            return mapping[tab];
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            sortColumn = null;
            sortDirection = 'asc';
            columnFilters = {};
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            renderTable();
            renderFilters();
            updateStats();
        }

        // Update statistics
        function updateStats() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            
            let totalRecords = sheetData.filter(row => !shouldHideRow(row)).length;

            const statsGrid = document.getElementById('statsGrid');
            
            if (!isAdmin) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalRecords}</div>
                        <div class="stat-label">Total Active Records as of ${todayFormatted}</div>
                    </div>
                `;
            } else {
                const allColumns = sheetData.length > 0 ? Object.keys(sheetData[0]) : [];
                const hiddenCols = HIDDEN_COLUMNS[sheetName] || [];
                const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalRecords}</div>
                        <div class="stat-label">Total Active Records as of ${todayFormatted}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${allColumns.length}</div>
                        <div class="stat-label">Columns Visible</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">Full</div>
                        <div class="stat-label">Access Level</div>
                    </div>
                `;
            }
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const rows = document.querySelectorAll('#dataTable tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let showRow = true;

                // Global search
                if (searchTerm) {
                    const text = row.textContent.toLowerCase();
                    if (!text.includes(searchTerm)) {
                        showRow = false;
                    }
                }

                // Column filters
                if (showRow) {
                    cells.forEach(cell => {
                        const col = cell.getAttribute('data-col');
                        if (col && columnFilters[col]) {
                            const cellText = cell.textContent.toLowerCase();
                            if (!cellText.includes(columnFilters[col])) {
                                showRow = false;
                            }
                        }
                    });
                }

                row.style.display = showRow ? '' : 'none';
            });
        }

        // Export to CSV
        function exportToCSV() {
            const sheetName = getSheetName(currentTab);
            const sheetData = data[sheetName] || [];
            
            if (sheetData.length === 0) {
                alert('No data to export');
                return;
            }

            const allColumns = Object.keys(sheetData[0]);
            const hiddenCols = isAdmin ? [] : (HIDDEN_COLUMNS[sheetName] || []);
            const visibleColumns = allColumns.filter(col => !hiddenCols.includes(col));

            let filteredData = sheetData.filter(row => !shouldHideRow(row));

            let csv = visibleColumns.join(',') + '\n';
            filteredData.forEach(row => {
                const values = visibleColumns.map(col => {
                    const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Format: "Q3 Consultancy - SheetName Data - YYYY-MM-DD.csv"
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `Q3 Consultancy - ${sheetName} Data - ${dateStr}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Save function (Admin only)
        function saveChanges() {
            if (!isAdmin) return;
            // Show toast confirmation
            const toast = document.getElementById('saveToast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Login functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('roleBadge').textContent = 'Admin';
                document.getElementById('roleBadge').classList.add('admin');
                document.getElementById('roleBadge').style.display = '';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('addBtn').classList.add('admin-only');
                document.getElementById('saveBtn').classList.add('admin-only');
                hideLoginModal();
                renderTable();
                renderFilters();
                updateStats();
            } else {
                alert('Incorrect password');
            }
        }

        function logout() {
            isAdmin = false;
            document.getElementById('roleBadge').textContent = 'External Viewer';
            document.getElementById('roleBadge').classList.remove('admin');
            document.getElementById('roleBadge').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('addBtn').classList.remove('admin-only');
            document.getElementById('saveBtn').classList.remove('admin-only');
            renderTable();
            renderFilters();
            updateStats();
        }

        // Initialize
        window.onload = function() {
            loadData();
        };

        // Allow Enter key for password + backdrop close for modals
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            }
            // Close modals by clicking backdrop
            document.getElementById('addDealModal').addEventListener('click', function(e) {
                if (e.target === this) hideAddDealModal();
            });
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) hideLoginModal();
            });
            // Close add deal modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAddDealModal();
                    hideLoginModal();
                }
            });
        });
    </script>

    <div class="toast" id="saveToast">‚úÖ Changes saved successfully!</div>
</body>
</html>
